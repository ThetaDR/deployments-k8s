---
apiVersion: v1
kind: Service
metadata:
  name: greeting
  labels:
    app: greeting
    service: greeting
spec:
  ports:
    - port: 9080
      name: http
  selector:
    app: greeting
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: default
  name: cert-file
data:
  root-cert.pem: |
    -----BEGIN CERTIFICATE-----
    MIIC/TCCAeWgAwIBAgIRAIYmtgUVTPSlCzz5fwD6hDIwDQYJKoZIhvcNAQELBQAw
    GDEWMBQGA1UEChMNY2x1c3Rlci5sb2NhbDAeFw0yMjExMDEwODQ4MzBaFw0zMjEw
    MjkwODQ4MzBaMBgxFjAUBgNVBAoTDWNsdXN0ZXIubG9jYWwwggEiMA0GCSqGSIb3
    DQEBAQUAA4IBDwAwggEKAoIBAQC+h0ikR6ZsxoHSx/C2glLW5qOvOMY02H+fMp8T
    aA6grOw+piOsTQlEMty1O+M6N0Ge+eYQSit3BnHIDHqsCIKe3yDxnD+zgmHM4KUK
    CTeltip7+K5A65W4yu53vpYQBhJErWek6pJp47AcJ+Xg6+04U/0w7y3CPqdupSV/
    c5s6qNFR+I/aXMgRklEMsyMjzYIVkfSiHbqO/j+SL4pLnYFuXa7p0U+p/Gr6j4r2
    iweqELsMBvzyt8nzt2bOXui20XUEYNDv/VVUpqPqmx2uRvRVKDlzObT9Lqf7JqqL
    MUkEcliJH92KQdYz8eSc0pDhH+854hImus+IZ781HSwhOkuJAgMBAAGjQjBAMA4G
    A1UdDwEB/wQEAwICBDAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBQ+IiqCLcso
    3jGd7UhZ1ZX1pBhi/zANBgkqhkiG9w0BAQsFAAOCAQEApKiIoExAB34xxUCs3BZJ
    VXDiHPaWBSLCmFO31keo0WFBhTUd++oDjUUgoI4Ze5UXrul01pix27Jo5LhM3EXx
    NlakfCC39p6YcOhjcn2ip6LjxbX11rsJPdloYMtBwXY6jXrSsn2eSkyL1RHxErcq
    q98akNv4IZPQU2VQ0YuEuHrC5M8H6Cp2tMToOqij52XvxfvzChTfuNpxayJW3h6D
    xdidkT1T+ImaMqRNAc0DuhRM1mLOJ1r1yT2A6pNF1eC7VHw3qro4ai0UzXrTErxU
    i1jiEydlpZ82rJLRFSRzKyXnF83vdTLmCDk39L6F9OLvXkYhBIdZr/3+t/G1q813
    nQ==
    -----END CERTIFICATE-----
  cluster.env: |
    CANONICAL_REVISION='latest'
    CANONICAL_SERVICE='vm-app'
    ISTIO_INBOUND_PORTS='*'
    ISTIO_LOCAL_EXCLUDE_PORTS='22,15090,15021,15020'
    ISTIO_METAJSON_LABELS='{"app":"vm-app","service.istio.io/canonical-name":"vm-app","service.istio.io/canonical-revision":"latest"}'
    ISTIO_META_CLUSTER_ID='Kubernetes'
    ISTIO_META_DNS_CAPTURE='true'
    ISTIO_META_MESH_ID='mesh1'
    ISTIO_META_NETWORK=''
    ISTIO_META_WORKLOAD_NAME='vm-app'
    ISTIO_NAMESPACE='vm-ns'
    ISTIO_SERVICE='vm-app.vm-ns'
    ISTIO_SERVICE_CIDR='*'
    POD_NAMESPACE='vm-ns'
    SERVICE_ACCOUNT='serviceaccountvm'
    TRUST_DOMAIN='cluster.local'
  istio-token: eyJhbGciOiJSUzI1NiIsImtpZCI6IkVQU1BTNTlQVEt3ekVHMndTejRqVWxyanVfTmJhbUV0NjhGUW4wTU83QU0ifQ.eyJhdWQiOlsiaXN0aW8tY2EiXSwiZXhwIjoxNjY3Mjk2NjIyLCJpYXQiOjE2NjcyOTMwMjIsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJ2bS1ucyIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJzZXJ2aWNlYWNjb3VudHZtIiwidWlkIjoiMDE0YjE4NTktMTAzNS00MmY2LWI2NWItOTc4NTY0ZWYyMmE2In19LCJuYmYiOjE2NjcyOTMwMjIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDp2bS1uczpzZXJ2aWNlYWNjb3VudHZtIn0.KHEaN_k4vRYpNYat7YRHIw7DHJ7hiM0BAhU5WLn1DJn13JOHSW6DvCWOG2koMgyJmQ43-nXnagfxeJWselwqcyqNJEhvsd-fFBXAPjPOWiVIrK5jOWILIF-GXx-GPCCsydmB5h_f5FQ8Wm8T2s_cDeSn2SPEgn5Hp7OgcTRssJlhRnJGTYceVvDMD94pHtg744UZzJdKOf4MpCvloo-WoVwUKx4ESGfOkXExLwM43-ROQ7O2rRIn4tPMdbdVvyY19pBka7FhOlsaVqCOHefwpRzSZr20bG5zoIjPI5QPV8Muy7yp7tb-eKy1oOK4RcxJnB8dRr0Sb67RVVSb2AbaKQ
  mesh: |
    defaultConfig:
      discoveryAddress: 10.96.228.158:15012
      meshId: mesh1
      proxyMetadata:
        CANONICAL_REVISION: latest
        CANONICAL_SERVICE: vm-app
        ISTIO_META_CLUSTER_ID: Kubernetes
        ISTIO_META_DNS_CAPTURE: "true"
        ISTIO_META_MESH_ID: mesh1
        ISTIO_META_NETWORK: ""
        ISTIO_META_WORKLOAD_NAME: vm-app
        ISTIO_METAJSON_LABELS: '{"app":"vm-app","service.istio.io/canonical-name":"vm-app","service.istio.io/canonical-revision":"latest"}'
        POD_NAMESPACE: vm-ns
        SERVICE_ACCOUNT: serviceaccountvm
        TRUST_DOMAIN: cluster.local
      serviceCluster: vm-app.vm-ns
      tracing:
        zipkin:
          address: zipkin.istio-system:9411
#---
#apiVersion: v1
#kind: ServiceAccount
#metadata:
#  name: greeting-sa
#  labels:
#    account: greeting
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: greeting
  labels:
    app: greeting
spec:
  replicas: 1
  selector:
    matchLabels:
      app: greeting
  template:
    metadata:
      labels:
        app: greeting
#      annotations:
#        networkservicemesh.io: kernel://my-vl3-network/nsm-1?dnsName=server
#        networkservicemesh.io: kernel://my-vl3-network@my.cluster1/nsm-1
    spec:
      volumes:
        - name: cert
          configMap:
            name: cert-file
#            items:
#              - key: root-cert.pem
#                path: root-cert.pem
#      serviceAccountName: greeting-sa
      containers:
        - name: server
          image: hashicorp/http-echo:alpine
          args:
            - -text="hello world from istio"
            - -listen=:9080
          ports:
            - containerPort: 9080
              name: http
        - args:
            - proxy
            - sidecar
            - --domain
            - ""
            - --proxyLogLevel=debug
            - --proxyComponentLogLevel=misc:debug
            - --log_output_level=default:debug
            - --concurrency
            - "0"
          env:
#              - name: CA_ROOT_CA
#                value: /etc/ca-cert.pem
#              - name: CONTROL_PLANE_AUTH_POLICY
#                value: NONE
              - name: JWT_POLICY
                value: third-party-jwt
              - name: PILOT_CERT_PROVIDER
                value: NONE
              - name: CA_ADDR
#                value: 10.244.1.2:15012
                value: 10.96.228.158:15012
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    apiVersion: v1
                    fieldPath: metadata.name
              - name: POD_NAMESPACE
                value: vm-ns
#              - name: INSTANCE_IP
#                valueFrom:
#                  fieldRef:
#                    apiVersion: v1
#                    fieldPath: status.podIP
              - name: SERVICE_ACCOUNT
                value: serviceaccountvm
#              - name: HOST_IP
#                valueFrom:
#                  fieldRef:
#                    apiVersion: v1
#                    fieldPath: status.hostIP
              - name: PROXY_CONFIG
                value: |
                  {}
              - name: ISTIO_META_POD_PORTS
                value: |-
                  [
                  ]
              - name: ISTIO_META_APP_CONTAINERS
                value: alpine
              - name: ISTIO_META_CLUSTER_ID
                value: Kubernetes
              - name: ISTIO_META_INTERCEPTION_MODE
                value: REDIRECT
              - name: ISTIO_META_WORKLOAD_NAME
                value: vm-app
#              - name: ISTIO_META_OWNER
#                value: kubernetes://apis/apps/v1/namespaces/default/deployments/alpine
              - name: ISTIO_META_MESH_ID
                value: cluster.local
              - name: TRUST_DOMAIN
                value: cluster.local
          image: docker.io/istio/proxyv2:1.15.2
          imagePullPolicy: IfNotPresent
          name: istio-proxy
          volumeMounts:
            - mountPath: /var/run/secrets/istio/root-cert.pem
              name: cert
              subPath: root-cert.pem
            - mountPath: /var/lib/istio/envoy/cluster.env
              name: cert
              subPath: cluster.env
            - mountPath: /etc/istio/config/mesh
              name: cert
              subPath: mesh
            - mountPath: /var/run/secrets/tokens/istio-token
              name: cert
              subPath: istio-token
          ports:
            - containerPort: 15090
              name: http-envoy-prom
              protocol: TCP
          readinessProbe:
            failureThreshold: 30
            httpGet:
              path: /healthz/ready
              port: 15021
              scheme: HTTP
            initialDelaySeconds: 1
            periodSeconds: 2
            successThreshold: 1
            timeoutSeconds: 3
          resources:
            limits:
              cpu: "2"
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 128Mi
      initContainers:
        - args:
                  - istio-iptables
                  - -p
                  - "15001"
                  - -z
                  - "15006"
                  - -u
                  - "1337"
                  - -m
                  - REDIRECT
                  - -i
                  - '*'
                  - -x
                  - ""
                  - -b
                  - '*'
                  - -d
                  - 15090,15021,15020
          image: docker.io/istio/proxyv2:1.15.2
          imagePullPolicy: IfNotPresent
          name: istio-init
          resources:
            limits:
                cpu: "2"
                memory: 1Gi
            requests:
                cpu: 100m
                memory: 128Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
                add:
                  - NET_ADMIN
                  - NET_RAW
                drop:
                  - ALL
            privileged: false
            readOnlyRootFilesystem: false
            runAsGroup: 0
            runAsNonRoot: false
            runAsUser: 0
