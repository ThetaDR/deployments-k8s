# NSM + linkerd interdomain example over kind clusters



This diagram shows that we have 2 clusters with NSM and also linkerd deployed on the Cluster-2.

In this example, we deploy an http-server (**Workload-2**) on the Cluster-2 and show how it can be reached from Cluster-1.

The client will be `alpine` (**Workload-1**), we will use curl.

## Requires

- [Load balancer](../../loadbalancer)
- [Interdomain DNS](../../dns)
- [Interdomain spire](../../spire)
- [Interdomain nsm](../../nsm)

Or you can run [interdomain script](../../../interdomain.sh)

## Run

Install linkerd for second cluster:
```bash
linkerd --kubeconfig=$KUBECONFIG2 check --pre
linkerd --kubeconfig=$KUBECONFIG2 install --crds | kubectl --kubeconfig=$KUBECONFIG2 apply -f -
linkerd --kubeconfig=$KUBECONFIG2 install > linkerd.yaml
```

Replace linkerd image just to get additional info in linkerd proxy containers
```
proxy:
  accessLog: ""
  await: true
  capabilities: null
  defaultInboundPolicy: all-unauthenticated
  enableExternalProfiles: false
  image:
    name: thetadr/linkerd-proxy
    pullPolicy: ""
    version: logs-linux-2-lldb
    logs-linux-debug 
    logs-linux-debian-sudo
    
    1647: image: thetadr/controller-linkerd:privileged
```

```bash
kubectl --kubeconfig=$KUBECONFIG2 apply -f linkerd.yaml
linkerd --kubeconfig=$KUBECONFIG2 check
```

Install networkservice for the second cluster:
```bash
kubectl --kubeconfig=$KUBECONFIG2 create ns ns-nsm-linkerd
kubectl --kubeconfig=$KUBECONFIG2 apply -f ./networkservice.yaml
```

Start `alpine` with networkservicemesh client on the first cluster:

```bash
kubectl --kubeconfig=$KUBECONFIG1 apply -f ./greeting/client.yaml
```

Start `auto-scale` networkservicemesh endpoint:
```bash
kubectl --kubeconfig=$KUBECONFIG2 apply -k ./nse-auto-scale
```

Install http-server for the second cluster:
```bash
kubectl --kubeconfig=$KUBECONFIG2 apply -f ./greeting/server.yaml
kubectl --kubeconfig=$KUBECONFIG2 get deploy greeting -o yaml | linkerd --kubeconfig=$KUBECONFIG2 inject - | kubectl --kubeconfig=$KUBECONFIG2 apply -f -
```


Wait for the `alpine` client to be ready:
```bash
kubectl --kubeconfig=$KUBECONFIG1 wait --timeout=2m --for=condition=ready pod -l app=alpine
```

Get curl for nsc:
```bash
kubectl --kubeconfig=$KUBECONFIG1 exec deploy/alpine -c cmd-nsc -- apk add curl
```

Add iptables to nse (copy pod name like proxy-alpine-86fc94c47-kqdtx manually)
```bash
PROXY_NAME=
kubectl --kubeconfig=$KUBECONFIG2 exec $PROXY_NAME -c nse -- apk add iptables
```

Add this iptables to proxy nse container.
172.16.1.3 - alpine nsm ip address
10.244.1.15 - proxy-alpine k8s ip address
```
-A POSTROUTING -j NSM_POST
-A NSM_POST -d 172.16.1.3/32 -j RETURN
-A NSM_POST -j SNAT --to-source 10.244.1.15
```

Verify connectivity:
```bash
kubectl --kubeconfig=$KUBECONFIG1 exec deploy/alpine -c cmd-nsc -- curl -s greeting.default:9080 | grep -o "hello world from linkerd"
```
**Expected output** is "hello world from linkerd"


latest tested iptables
# Generated by iptables-save v1.8.8 on Tue Dec 20 09:38:37 2022
*nat
:PREROUTING ACCEPT [7720:357792]
:INPUT ACCEPT [7728:358272]
:OUTPUT ACCEPT [5:300]
:POSTROUTING ACCEPT [0:0]
:NSM_POST - [0:0]
:PROXY_INIT_OUTPUT - [0:0]
:PROXY_INIT_REDIRECT - [0:0]
-A PREROUTING -d 10.96.0.10/32 -j RETURN
-A PREROUTING -m comment --comment "proxy-init/install-proxy-init-prerouting/1671521120" -j PROXY_INIT_REDIRECT
-A INPUT -p tcp -j LOG
-A OUTPUT -d 10.96.0.10/32 -j RETURN
-A OUTPUT -m comment --comment "proxy-init/install-proxy-init-output/1671521120" -j PROXY_INIT_OUTPUT
-A POSTROUTING -j NSM_POST
-A NSM_POST -d 172.16.1.3/32 -j RETURN
-A NSM_POST -j SNAT --to-source 10.244.1.15
-A PROXY_INIT_OUTPUT -m owner --uid-owner 2102 -m comment --comment "proxy-init/ignore-proxy-user-id/1671521120" -j RETURN
-A PROXY_INIT_OUTPUT -o lo -m comment --comment "proxy-init/ignore-loopback/1671521120" -j RETURN
-A PROXY_INIT_OUTPUT -p tcp -m multiport --dports 4567,4568 -m comment --comment "proxy-init/ignore-port-4567,4568/1671521120" -j RETURN
-A PROXY_INIT_OUTPUT -p tcp -m comment --comment "proxy-init/redirect-all-outgoing-to-proxy-port/1671521120" -j REDIRECT --to-ports 4140
-A PROXY_INIT_REDIRECT -p tcp -m multiport --dports 4190,4191,4567,4568 -m comment --comment "proxy-init/ignore-port-4190,4191,4567,4568/1671521120" -j RETURN
-A PROXY_INIT_REDIRECT -p tcp -m comment --comment "proxy-init/redirect-all-incoming-to-proxy-port/1671521120" -j REDIRECT --to-ports 4143
COMMIT
# Completed on Tue Dec 20 09:38:37 2022
